name: Build Portable Tarballs

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: amd64
            bun_target: bun-linux-x64
          - arch: arm64
            bun_target: bun-linux-aarch64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Download Bun runtime (${{ matrix.arch }})
        run: |
          BUN_VERSION=$(bun --version)
          curl -fL "https://github.com/oven-sh/bun/releases/download/bun-v${BUN_VERSION}/${{ matrix.bun_target }}.zip" -o bun.zip
          unzip bun.zip
          chmod +x ${{ matrix.bun_target }}/bun

      - name: Package tarball
        run: |
          DIST=scorlller-dist
          mkdir -p $DIST
          cp -r .next/standalone/. $DIST/
          cp -r .next/static $DIST/.next/static
          cp -r public $DIST/public
          cp ${{ matrix.bun_target }}/bun $DIST/bun
          cat > $DIST/start.sh << 'EOF'
          #!/bin/sh
          DIR="$(cd "$(dirname "$0")" && pwd)"
          exec "$DIR/bun" "$DIR/server.js" "$@"
          EOF
          chmod +x $DIST/start.sh
          tar -czf scorlller-linux-${{ matrix.arch }}.tar.gz $DIST

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: scorlller-linux-${{ matrix.arch }}
          path: scorlller-linux-${{ matrix.arch }}.tar.gz
          retention-days: 30

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: scorlller-linux-${{ matrix.arch }}.tar.gz
