# ─── Disk cache for redgifs videos ──────────────────────────────────────────
# Stores video slices on disk. max_size caps total; inactive evicts after 7d.
proxy_cache_path /var/cache/nginx/redgifs
    levels=1:2
    keys_zone=redgifs:10m
    max_size=5g
    inactive=7d
    use_temp_path=off;

server {
    listen 80;

    # ─── Reddit JSON API proxy ───────────────────────────────────────────────
    # nginx uses OpenSSL → avoids Go TLS fingerprint that causes Reddit 403/429.
    location /proxy/reddit/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin  "*";
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
            add_header Access-Control-Max-Age       "86400";
            return 204;
        }

        proxy_pass              https://www.reddit.com/;
        proxy_ssl_server_name   on;

        proxy_set_header Host               "www.reddit.com";
        proxy_set_header User-Agent         "scorlller/2.0 by Nachtalb";
        proxy_set_header Cookie             "";
        proxy_set_header Referer            "";
        proxy_set_header X-Forwarded-For   "";
        proxy_set_header X-Forwarded-Host  "";
        proxy_set_header X-Forwarded-Proto "";
        proxy_set_header X-Real-IP          "";
        proxy_set_header Via                "";
        proxy_set_header Forwarded          "";

        proxy_hide_header Set-Cookie;

        add_header Access-Control-Allow-Origin  "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
    }

    # ─── Redgifs media proxy — streaming + disk cache ────────────────────────
    # slice: splits into 1MB chunks fetched with Range requests.
    # Each chunk is cached individually and streamed to the client as it arrives —
    # no full-download-then-serve buffering.
    location /proxy/redgifs/ {
        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin   "*";
            add_header Access-Control-Allow-Methods  "GET, HEAD, OPTIONS";
            add_header Access-Control-Max-Age        "86400";
            return 204;
        }

        slice                   1m;
        proxy_cache             redgifs;
        proxy_cache_key         "$uri$slice_range";
        proxy_cache_valid       200 206 7d;
        proxy_cache_lock        on;
        proxy_cache_use_stale   error timeout updating;
        add_header              X-Cache-Status $upstream_cache_status always;

        proxy_pass              https://media.redgifs.com/;
        proxy_ssl_server_name   on;

        # Forward the current slice's Range header to upstream
        proxy_set_header Range $slice_range;

        # Spoof browser identity — CDN77 rejects non-browser requests
        proxy_set_header Host       "media.redgifs.com";
        proxy_set_header User-Agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36";
        proxy_set_header Referer    "https://www.redgifs.com/";
        proxy_set_header Origin     "https://www.redgifs.com";
        proxy_set_header Cookie     "";
        proxy_set_header X-Forwarded-For   "";
        proxy_set_header X-Forwarded-Host  "";
        proxy_set_header X-Forwarded-Proto "";
        proxy_set_header X-Real-IP          "";
        proxy_set_header Via                "";
        proxy_set_header Forwarded          "";

        proxy_hide_header Set-Cookie;

        add_header Access-Control-Allow-Origin   "*" always;
        add_header Access-Control-Allow-Methods  "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range, Accept-Ranges" always;
    }

    # ─── TODO: preview.redd.it, SPA static serving ──────────────────────────
    location / {
        return 502 "not yet implemented\n";
    }
}
