{
	admin off
	auto_https off

	cache {
		ttl 24h
		stale 1h
	}
}

:{$PORT:3000} {

	@options method OPTIONS
	handle @options {
		header Access-Control-Allow-Origin  "*"
		header Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
		header Access-Control-Max-Age       "86400"
		respond 204
	}

	handle /proxy/redgifs/* {
		uri strip_prefix /proxy/redgifs
		cache
		reverse_proxy https://media.redgifs.com {
			header_up Host            "media.redgifs.com"
			header_up User-Agent      "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36"
			header_up Referer         "https://www.redgifs.com/"
			header_up Origin          "https://www.redgifs.com"
			header_up -Cookie
			header_up -X-Forwarded-For
			header_up -X-Forwarded-Host
			header_up -X-Forwarded-Proto
			header_up -X-Real-Ip
			header_up -Via
			header_down Access-Control-Allow-Origin   "*"
			header_down Access-Control-Allow-Methods  "GET, HEAD, OPTIONS"
			header_down Access-Control-Expose-Headers "Content-Length, Content-Range, Accept-Ranges"
			header_down -Set-Cookie
		}
	}

	handle /proxy/preview/* {
		uri strip_prefix /proxy/preview
		reverse_proxy https://preview.redd.it {
			header_up Host "preview.redd.it"
			header_up -Cookie
			header_up -X-Forwarded-For
			header_up -X-Forwarded-Host
			header_up -X-Forwarded-Proto
			header_up -X-Real-Ip
			header_up -Via
			header_down Access-Control-Allow-Origin  "*"
			header_down Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
			header_down -Set-Cookie
		}
	}

	handle /proxy/ext-preview/* {
		uri strip_prefix /proxy/ext-preview
		reverse_proxy https://external-preview.redd.it {
			header_up Host "external-preview.redd.it"
			header_up -Cookie
			header_up -X-Forwarded-For
			header_up -X-Forwarded-Host
			header_up -X-Forwarded-Proto
			header_up -X-Real-Ip
			header_up -Via
			header_down Access-Control-Allow-Origin  "*"
			header_down Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
			header_down -Set-Cookie
		}
	}

	# Dev: forward everything else to Vite dev server (HMR WebSocket passes through)
	handle {
		reverse_proxy localhost:5173
	}
}
